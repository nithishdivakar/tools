<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SING</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
:root { 
    --accent: #2563eb; 
    --root-accent: #4f46e5; /* New Deep Indigo for Root */
    --border: #e5e7eb; 
    --text: #1f2937; 
}

/* Force black text for all interactive elements to fix iOS blue text */
body, button, input, select, textarea { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: var(--text); 
    -webkit-text-fill-color: var(--text); /* Fix for some mobile browsers */
}

body { background: #fff; padding: 1rem; margin: 0; line-height: 1.5; }
.container { max-width: 650px; margin: 0 auto; }

.section { margin-bottom: 1.5rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 1.25rem; }
.label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #9ca3af; letter-spacing: 0.1em; margin-bottom: 12px; display: block; }

.btn-group { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; justify-content: center;}

/* Standard Buttons */
button { 
    border: 1px solid var(--border); 
    background: #fff; 
    padding: 10px 14px; 
    font-size: 0.75rem; 
    cursor: pointer; 
    border-radius: 6px; 
}
button.active { background: var(--text); color: white; -webkit-text-fill-color: white; border-color: var(--text); }
button.primary { background: var(--accent); color: white; -webkit-text-fill-color: white; border: none; font-weight: 700; width: 100%; padding: 15px; }
button.stop { background: #000; color: #fff; -webkit-text-fill-color: white; border: none; width: 100%; padding: 15px; }

/* Note Containers */
.flex-container { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }

.note-btn { 
    flex: 0 0 auto;
    width: 40px; 
    height: 40px;
    aspect-ratio: 1 / 1; 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem; 
    padding: 0; 
    transition: transform 0.1s ease;
}

/* Specific styling for Root Note selectors */
.root-note-btn { 
    width: 32px; /* Smaller size for root selector */
    height: 32px;
    font-size: 0.6rem;
    background-color: #f8fafc;
}
.root-note-btn.active { 
    background-color: var(--root-accent) !important; 
    border-color: var(--root-accent);
    color: white !important;
    -webkit-text-fill-color: white !important;
}

/* Playback States */
.note-btn.selected { background: #eff6ff; border-color: var(--accent); color: var(--accent); font-weight: bold; }
.note-btn.playing { 
    background: var(--accent) !important; 
    color: white !important; 
    -webkit-text-fill-color: white !important;
    transform: scale(1.1); 
    z-index: 10;
    box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
}

/* Scale Cards */
.btn-group button.scale-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-width: 60px;
    max-width: 100px;
    justify-content: center;
    gap: 2px;
}
.tag-main { font-weight: 700; font-size: 0.75rem; }
.tag-sub { font-size: 0.4rem; opacity: 0.7; scrollbar-gutter: stable; overflow: scroll;}

input[type="range"] { flex: 1; accent-color: var(--accent); }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="section">
        <span class="label">Scale selector</span>
        

        <div class="btn-group">
            <button 
                v-for="(pattern, name) in SCALES" 
                @click="applyScale(name)" 
                :class="['scale-btn', { active: activeScale === name }]"
            >
                <div class="tag-main">{{ name }}</div>
                <div class="tag-sub">
                    {{ pattern.map(offset => getNoteFromOffset(offset)).join(', ') }}
                </div>            
            </button>
            
        </div>
        <div class="btn-group">
            <button @click="clearSelection">Clear</button>
        </div>
    </div>
    <div class="section" v-if="activeScale">
        <span class="label">Root Note Selector</span>
        <div class="flex-container">
            <button v-for="n in masterRange" 
                    @click="setRoot(n)" 
                    :class="['note-btn root-note-btn', { active: rootNote?.name === n.name }]">
                {{ n.name }}
            </button>
        </div>
    </div>

    <div class="section">
        <span class="label">Notes</span>
        <div class="flex-container">
            <button v-for="n in masterRange" @click="toggleNote(n)" 
                    :class="['note-btn', { selected: isSelected(n), playing: currentNote === n.name }]">
                {{ n.name }}
            </button>
        </div>
    </div>
    <div class="section">
        <span class="label">Tempo ({{ bpm }} BPM)</span>
        <div class="flex-container">
            <button 
                v-for="t in [
                    {n: 'Largo', v: 50}, 
                    {n: 'Adagio', v: 72}, 
                    {n: '80', v: 80},
                    {n: 'Andante', v: 90},
                    {n: 'Moderato', v: 115}, 
                    {n: '120', v: 120}, 
                    {n: 'Allegro', v: 135}, 
                    {n: '150', v: 150}, 
                    {n: 'Presto', v: 180}
                ]"
                @click="bpm = t.v"
                :class="['scale-btn', { active: bpm === t.v }]"
            >
                <div class="tag-main">{{ t.n }}</div>
                <div class="tag-sub">{{ t.v }}</div>
            </button>
        </div>
        
        <div class="ctrl-row" style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
            <input type="range" v-model.number="bpm" min="40" max="220" style="flex: 1;">
        </div>
    </div>
    
    <div class="section">
        <span class="label">Playback</span>
        <div class="btn-group">
            <button 
                @click="autoAdvance=!autoAdvance" 
                :class="['scale-btn', { active: autoAdvance }]"
                style="max-width: fit-content;"
            >Auto-Advance Root</button>
        </div>
        <div class="btn-group">
            <span v-if="autoAdvance"> every <input type="number" v-model="kReps" style="width: 30px;"> reps</span>
        </div>
        <div class="btn-group">
            <button @click="mode = 'loop'" :class="{ active: mode === 'loop' }">Repeat</button>
            <button @click="mode = 'pendulum'" :class="{ active: mode === 'pendulum' }">Pendulum</button>
        </div>
        <div style="margin-top: 20px;">
            <button v-if="!isPlaying" class="primary" @click="start" :disabled="selectedNotes.length === 0">LOOP</button>
            <button v-else class="stop" @click="stop">STOP</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref } = Vue;

// --- DOMAIN CONSTANTS ---
const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const SCALES = {
    'Major': [0, 2, 4, 5, 7, 9, 11, 12],
    'Dorian (D)': [0, 2, 3, 5, 7, 9, 10, 12],
    'Phrygian (E)': [0, 1, 3, 5, 7, 8, 10, 12],
    'Lydian (F)': [0, 2, 4, 6, 7, 9, 11, 12],
    'Mixolydian (G)': [0, 2, 4, 5, 7, 9, 10, 12],
    'Minor / Aeolian (A)': [0, 2, 3, 5, 7, 8, 10, 12],
    'Locrian (B)': [0, 1, 3, 5, 6, 8, 10, 12],
    'Pentatonic': [0, 2, 4, 7, 9, 12],
    'Scale 1.5': [0, 4, 7, 12,  16, 19, 17, 14, 11, 7, 5, 2, 0, -1, -1, -1], // Grand Arpeggio" followed by a scalar descent
    '1.5 Octave Zig-Zag': [0, 2, 4, 6, 7, 9, 11, 13, 14, 12, 10, 8, 7, 5, 3, 1, 0],
    'Interval Jumps': [0, 4, 2, 5, 4, 7, 5, 9, 7, 11, 9, 12, 12, 9, 11, 7, 9, 5, 7, 4, 5, 2, 4, 0],
    'The Turn': [0, 2, 1, 0, 4, 6, 5, 4, 7, 9, 8, 7, 12, 11, 10, 12, 0],

    'Major + 1': [0,2,4,5,  7,9,11,12, 14,12,11,9, 7,5,4,2, 0,-1,-1,-1],
    'Maj8 arpeggio': [0, 4, 7, 12, 7, 4, 0, -1],
    'ex2': [0, 4, 7, 12,12,12,12, 7, 4, 0, -1, -1]
};

const AudioEngine = {
    ctx: null,
    resume() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },
    play(freq, dur) {
        // We assume resume() was called by the start button
        if (!this.ctx) return; 
        
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sine';
        // osc.type = 'square';
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        // Anti-pop envelope
        gain.gain.setValueAtTime(0, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + dur);
        
        osc.connect(gain); 
        gain.connect(this.ctx.destination);
        
        osc.start(); 
        osc.stop(this.ctx.currentTime + dur);
    }
};

createApp({
    setup() {
        const masterRange = [
            // --- Octave 2 (65.41Hz - 123.47Hz) ---
            { name: "C2", freq: 65.41, absIndex: 24 }, { name: "C#2", freq: 69.30, absIndex: 25 },
            { name: "D2", freq: 73.42, absIndex: 26 }, { name: "D#2", freq: 77.78, absIndex: 27 },
            { name: "E2", freq: 82.41, absIndex: 28 }, { name: "F2", freq: 87.31, absIndex: 29 },
            { name: "F#2", freq: 92.50, absIndex: 30 }, { name: "G2", freq: 98.00, absIndex: 31 },
            { name: "G#2", freq: 103.83, absIndex: 32 }, { name: "A2", freq: 110.00, absIndex: 33 },
            { name: "A#2", freq: 116.54, absIndex: 34 }, { name: "B2", freq: 123.47, absIndex: 35 },

            // --- Octave 3 (130.81Hz - 246.94Hz) ---
            { name: "C3", freq: 130.81, absIndex: 36 }, { name: "C#3", freq: 138.59, absIndex: 37 },
            { name: "D3", freq: 146.83, absIndex: 38 }, { name: "D#3", freq: 155.56, absIndex: 39 },
            { name: "E3", freq: 164.81, absIndex: 40 }, { name: "F3", freq: 174.61, absIndex: 41 },
            { name: "F#3", freq: 185.00, absIndex: 42 }, { name: "G3", freq: 196.00, absIndex: 43 },
            { name: "G#3", freq: 207.65, absIndex: 44 }, { name: "A3", freq: 220.00, absIndex: 45 },
            { name: "A#3", freq: 233.08, absIndex: 46 }, { name: "B3", freq: 246.94, absIndex: 47 },

            // --- Octave 4 (261.63Hz - 493.88Hz) ---
            { name: "C4", freq: 261.63, absIndex: 48 }, { name: "C#4", freq: 277.18, absIndex: 49 },
            { name: "D4", freq: 293.66, absIndex: 50 }, { name: "D#4", freq: 311.13, absIndex: 51 },
            { name: "E4", freq: 329.63, absIndex: 52 }, { name: "F4", freq: 349.23, absIndex: 53 },
            { name: "F#4", freq: 369.99, absIndex: 54 }, { name: "G4", freq: 392.00, absIndex: 55 },
            { name: "G#4", freq: 415.30, absIndex: 56 }, { name: "A4", freq: 440.00, absIndex: 57 },
            { name: "A#4", freq: 466.16, absIndex: 58 }, { name: "B4", freq: 493.88, absIndex: 59 },

            // --- Octave 5 (523.25Hz - 987.77Hz) ---
            { name: "C5", freq: 523.25, absIndex: 60 }, { name: "C#5", freq: 554.37, absIndex: 61 },
            { name: "D5", freq: 587.33, absIndex: 62 }, { name: "D#5", freq: 622.25, absIndex: 63 },
            { name: "E5", freq: 659.25, absIndex: 64 }, { name: "F5", freq: 698.46, absIndex: 65 },
            { name: "F#5", freq: 739.99, absIndex: 66 }, { name: "G5", freq: 783.99, absIndex: 67 },
            { name: "G#5", freq: 830.61, absIndex: 68 }, { name: "A5", freq: 880.00, absIndex: 69 },
            { name: "A#5", freq: 932.33, absIndex: 70 }, { name: "B5", freq: 987.77, absIndex: 71 },

            // --- Octave 6 (1046.50Hz - 1975.53Hz) ---
            { name: "C6", freq: 1046.50, absIndex: 72 }, { name: "C#6", freq: 1108.73, absIndex: 73 },
            { name: "D6", freq: 1174.66, absIndex: 74 }, { name: "D#6", freq: 1244.51, absIndex: 75 },
            { name: "E6", freq: 1318.51, absIndex: 76 }, { name: "F6", freq: 1396.91, absIndex: 77 },
            { name: "F#6", freq: 1479.98, absIndex: 78 }, { name: "G6", freq: 1567.98, absIndex: 79 },
            { name: "G#6", freq: 1661.22, absIndex: 80 }, { name: "A6", freq: 1760.00, absIndex: 81 },
            { name: "A#6", freq: 1864.66, absIndex: 82 }, { name: "B6", freq: 1975.53, absIndex: 83 }
        ];

        const selectedNotes = ref([]);
        const rootNote = ref(masterRange.find(n => n.name === 'C4'));
        const activeScale = ref(null);
        const bpm = ref(120);
        const mode = ref('loop');
        const isPlaying = ref(false);
        const currentNote = ref('');
        
        // New reactive state for Auto-Advance
        const autoAdvance = ref(false);
        const kReps = ref(2); 
        let repCounter = 0;

        let timer = null;
        let seqIndex = 0;
        let direction = 1;

        const applyScale = (scaleName) => {
            activeScale.value = scaleName;
            const pattern = SCALES[scaleName];
            const rootIdx = rootNote.value.absIndex;
            
            selectedNotes.value = pattern.map(diff => {
                if (diff === -1) return { name: 'REST', freq: 0, absIndex: -1 }; // Silence Object
                return masterRange.find(note => note.absIndex === rootIdx + diff);
            }).filter(n => n !== undefined);
        };

        const tick = () => {
            if (!isPlaying.value || selectedNotes.value.length === 0) return;

            const note = selectedNotes.value[seqIndex];
            currentNote.value = note.name;
            const dur = 60 / bpm.value;
            AudioEngine.play(note.freq, dur);

            let nextIndex;
            if (mode.value === 'loop') {
                nextIndex = (seqIndex + 1) % selectedNotes.value.length;
                if (nextIndex === 0) handleRepetition();
            } else {
                nextIndex = seqIndex + direction;
                if (nextIndex >= selectedNotes.value.length - 1 || nextIndex <= 0) {
                    direction *= -1;
                    if (nextIndex <= 0) handleRepetition();
                }
            }
            
            seqIndex = nextIndex;
            timer = setTimeout(tick, dur * 1000);
        };

        const handleRepetition = () => {
            repCounter++;
            if (autoAdvance.value && repCounter >= kReps.value) {
                repCounter = 0;
                const nextRootIdx = rootNote.value.absIndex + 1;
                const nextRoot = masterRange.find(n => n.absIndex === nextRootIdx);
                if (nextRoot) {
                    rootNote.value = nextRoot;
                    applyScale(activeScale.value);
                }
            }
        };

        const setRoot = (note) => {
            rootNote.value = note;
            const dur = 60 / bpm.value;
            AudioEngine.resume();
            AudioEngine.play(note.freq, dur);
            if (activeScale.value) applyScale(activeScale.value);
        };

        const toggleNote = (note) => {
            activeScale.value = null; 
            const idx = selectedNotes.value.findIndex(n => n.absIndex === note.absIndex);
            
            if (idx > -1) {
                selectedNotes.value.splice(idx, 1);
            } else {
                selectedNotes.value.push(note);
                const dur = 60 / bpm.value;
                AudioEngine.resume();
                AudioEngine.play(note.freq, dur);
            }
        };



        const start = () => {
            // CRITICAL: Initialize audio context inside the click handler
            AudioEngine.resume(); 
            
            isPlaying.value = true;
            seqIndex = 0;
            direction = 1;
            tick();
        };

        const stop = () => {
            isPlaying.value = false;
            clearTimeout(timer);
            currentNote.value = '';
        };

        return {
            SCALES, masterRange, selectedNotes, rootNote, activeScale,
            bpm, mode, isPlaying, currentNote, autoAdvance, kReps,
            applyScale, setRoot, toggleNote, start, stop,
            getNoteFromOffset: (off) => off === -1 ? '-' : masterRange.find(n => n.absIndex === rootNote.value.absIndex + off)?.name,
            clearSelection: () => { selectedNotes.value = []; activeScale.value = null; },
            isSelected: (n) => selectedNotes.value.some(sn => sn.absIndex === n.absIndex)
        };
    }
}).mount('#app');
</script>
</body>
</html>