<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>READ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="feed-config.js"></script>
    <script src="rss-engine.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --border: #e2e8f0;
            --blue: #007bff; --green: #28a745; --red: #dc3545;
            --yellow: #ffc107; --white: #fff; --black: #000;
            --gray: #6c757d;
        }

        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding: 20px; }
        .flex { display: flex; } .items-center { align-items: center; } .gap-2 { gap: 8px; }
        .container { max-width: 900px; margin: 0 auto; }

        /* Tag Styling */
        .tag {
            --accent: var(--green);
            font-size: 0.75rem; padding: 6px 14px; border-radius: 12px;
            cursor: pointer; white-space: nowrap; border: 2px dashed var(--gray);
            transition: all 0.2s ease-in-out; display: inline-flex;
            flex-direction: column; align-items: center; gap: 2px; background: var(--white);
        }
        .tag.selected { border-style: solid; border-color: var(--accent); color: var(--accent); }
        .tag:hover { filter: brightness(92%); transform: translateY(-1px); }
        .tag.success { --accent: var(--blue); }
        .tag.error { --accent: var(--red); }
        .tag.waiting, .tag.fetching { --accent: var(--yellow); }
        .tag.muted { --accent: var(--gray); }
        .tag.stone { --accent: var(--black); }

        .tag-main { display: flex; align-items: center; gap: 6px; font-weight: 600; }
        .tag-sub { font-size: 0.6rem; opacity: 0.5; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
        .count { font-size: 0.65rem; font-weight: 400; opacity: 0.7; }

        /* Controls */
        .controls {
            background: var(--white); padding: 12px 15px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky; top: 10px; z-index: 100; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 4px;
        }
        .source-scroll { display: flex; overflow-x: auto; gap: 8px; padding: 4px 0 8px; -webkit-overflow-scrolling: touch; }
        .source-header { display: flex; justify-content: space-between; align-items: center; }
        .bulk-actions { font-size: 0.75rem; display: flex; gap: 4px; align-items: center; }

        /* Text Buttons */
        .txt-btn { --accent: var(--blue); color: var(--accent); cursor: pointer; font-weight: bold; padding: 2px 5px; }
        .txt-btn:hover, .txt-btn.selected { text-decoration: underline var(--accent) solid 2px; }
        .txt-btn.not-selected, .txt-btn.ph { --accent: var(--gray); cursor: default; }
        .txt-btn.ph:hover { text-decoration: none; }

        /* Feed Layouts */
        .feed-container { display: flex; flex-direction: column; gap: 16px; }
        .item { background: var(--white); padding: 12px; border-radius: 8px; border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .item:hover { border-color: var(--border); }

        .feed-container.list .item { display: flex; gap: 12px; }
        .feed-container.list .thumb { width: 75px; height: 75px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }

        .feed-container.card .item { display: flex; flex-direction: column; gap: 10px; }
        .feed-container.card .thumb { width: 100%; aspect-ratio: 16 / 9; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }

        /* Content Meta */
        .content { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .meta { font-size: 0.7rem; color: #64748b; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .source-icon { width: 12px; height: 12px; border-radius: 2px; }
        .star-icon { color: var(--yellow); }
        .title { font-weight: 700; text-decoration: none; color: #0f172a; font-size: 1.05rem; margin-bottom: 6px; line-height: 1.3; }
        .title:visited { color: #64748b; }
        .blurb { font-size: 0.85rem; color: #475569; line-height: 1.4; word-break: break-word; }

        .logo { font-weight: 900; letter-spacing: 1px; color: #0f172a; }
        .debug-grid { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
        .pill { border: 1px solid var(--border); border-radius: 4px; padding: 2px 4px; font-size: 0.8rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); }}
        .spinning {animation: spin 1s linear infinite; display: inline-block;}
    </style>
</head>
<body>

<div id="app" class="container">

<div class="controls">
    <div style="display: flex;justify-content: space-between;">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <span class="logo">READ</span>
        </div>

        <div class="bulk-actions">
            <span :class="['txt-btn', { 'selected': viewMode === 'list' }]"  @click="viewMode = 'list'">䷀ LIST</span>
            <span :class="['txt-btn', { 'selected': viewMode === 'card' }]"  @click="viewMode = 'card'">〓 CARD</span>
        </div>
    </div>
    <div class="bulk-actions">
        <span class='txt-btn ph' style="padding-left: 0;">Days:</span>
        <span :class="['txt-btn', { 'selected': dateMode === '1' }]"  @click="setDatePreset(1)">1</span>
        <span :class="['txt-btn', { 'selected': dateMode === '3' }]"  @click="setDatePreset(3)">3</span>
        <span :class="['txt-btn', { 'selected': dateMode === '7' }]"  @click="setDatePreset(7)">7</span>
        <span :class="['txt-btn', { 'selected': dateMode === 'custom' }]" @click="setDatePreset('custom')">set</span>
        <span :class="['txt-btn', { 'selected': dateMode === 'ee' }]" @click="setDatePreset('ee')">all</span>
    </div>

    <div v-if="dateMode === 'custom'" class="flex items-center gap-2">
        <input type="date" v-model="filters.start" class="pill">
        <span>to</span>
        <input type="date" v-model="filters.end" class="pill">
    </div>

    <div class="source-header">
        <div class="bulk-actions">
            <span class='txt-btn ph' style="padding-left: 0;">Sets:</span>
            <span v-for="tag in allTags"
                  :key="tag"
                  :class="['txt-btn', { 'selected': activeTag === tag }]"
                  @click="selectTag(tag)">
                {{ tag }}
            </span>
        </div>
        <div class="bulk-actions">
            <span style="font-size: xx-small;color:#475569"> W{{ statusCounts.waiting }}|D{{ statusCounts.success }}|F{{ statusCounts.error }}|T{{ sourceStates.length }} {{displayedItems}}/{{totalItems}}</span>

        </div>
    </div>


    <div class="source-scroll">
        <div v-for="source in sourceStates"
             :key="source.url"
             @click="toggleSource(source.url)"
             :class="['tag', `${source.status}`, { selected: filters.selectedSources.has(source.url), star: source.starred }]">

            <div class="tag-main">
                <span v-if="source.starred" class="star-icon">★</span>
                <img :src="getFavicon(source.url)" class="source-icon" onerror="this.style.display='none'">
                <span>{{ source.displayName }}</span>
                <span class="count">({{ source.count.visible }}/{{ source.count.total }})</span>
                <span :class="['txt-btn', { 'spinning': source.status === 'fetching' }]"
                    style="font-size: 0.7rem;"
                    @click.stop="refreshSource(source)">↻</span>
            </div>

            <div class="tag-sub">
                {{ source.url }}
            </div>
        </div>
    </div>
</div>


<div :class="['feed-container', viewMode === 'card' ? 'card' : 'list']">
    <div v-for="item in sortedArticles" :key="item.link" v-show="item.display" class="item">
            <img v-if="item.image" :src="item.image" class="thumb" onerror="this.style.display='none'">
            <div class="content">
                <div class="meta">
                    <span v-if="item.sourceStarred" class="star-icon">★</span>
                    <span v-if="item.sourceStarred">•</span>
                    <img :src="getFavicon(item.link)" class="source-icon" onerror="this.style.display='none'">
                    {{ item.sourceName }}
                    •
                    {{ formatDate(item.date) }}
                    •
                    <span @click.stop="toggleSource(item.sourceId)" style="cursor: pointer;">[:g//d]</span>
                </div>
                <a :href="item.link" target="_blank" class="title">{{ item.title }}</a>
                <div class="blurb" style="margin-top: 4px;">
                    {{item.snippet.substring(0, item.snippet_length)}} <span v-if="item.snippet_length < item.snippet.length">...</span>
                    <!-- [{{item.snippet_length}}|{{item.snippet.length}}] -->
                    <span class="txt-btn" style="padding-right:" v-if="item.snippet_length < item.snippet.length" @click="item.snippet_length = Math.max(160, (item.snippet_length || 160) + 500);">more</span>
                    <span class="txt-btn" style="padding:0"v-if="item.snippet_length < item.snippet.length && item.snippet_length > 160">/</span>
                    <span class="txt-btn" style="padding-left:" v-if="item.snippet_length > 160" @click="item.snippet_length = Math.max(160, (item.snippet_length || 160) - 500);">less</span>
                </div>
            </div>
    </div>
</div>

    <details style="margin-top: 30px;">
        <summary>
            debug
        </summary>
        <div class="debug-grid">
            <template v-for="state in ['default', 'success', 'error', 'waiting', 'muted']" :key="state">
              <template v-for="sel in ['selected', 'not selected']" :key="sel">
                <template v-for="hasStar in [true, false]" :key="hasStar">
                  <div
                    v-for="hasCount in [true, false]"
                    :key="hasCount"
                    class="tag"
                    :class="[state, { 'selected': sel === 'selected', 'star': hasStar }]"
                  >
                    <div class="tag-main">
                      <span v-if="hasStar" class="star-icon">★</span>
                      <span>{{ state }}</span>
                      <span v-if="hasCount" class="count">(2)</span>
                    </div>
                    <div class="tag-sub">
                      {{ sel }} {{ hasStar ? '+ star' : '' }} {{ hasCount ? '+ count' : '' }}
                    </div>
                  </div>
                </template>
              </template>
            </template>
            <br>
            <code style="font-size:xx-small;">
                <template v-for="entry in articlesCount" :key="entry.month">
                    {{ entry.month }}:{{ entry.count }} |
                </template>
            </code>
        </div>
    </details>
</div>

<script>
const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

createApp({
    setup() {
        const articles = ref([]);
        const viewMode = ref('list');
        const seenLinks = new Set();
        const filters = reactive({ start: '', end: '', selectedSources: new Set() });
        const dateMode = ref('3');
        const activeTag = ref('star');

        const sourceStates = reactive(FEED_CONFIG.map(config => {
            let tags = config.tags || ['untag'];

            return {
                url: config.url,
                displayName: config.name || 'fetching...',
                count: { visible: 0, total: 0 },
                status: 'waiting',
                tags: tags,
                starred: tags.includes('star')
            }
        }));

        const allTags = computed(() => {
            const tags = new Set(['all']);
            sourceStates.forEach(s => s.tags.forEach(t => tags.add(t)));
            tags.add('none');
            return Array.from(tags);
        });

        const updateVisibility = () => {
            sourceStates.forEach(s => s.count.visible = 0);

            articles.value.forEach(item => {
                const itemDate = new Date(item.date).toISOString().split('T')[0];
                const withinStart = !filters.start || itemDate >= filters.start;
                const withinEnd = !filters.end || itemDate <= filters.end;
                const sourceActive = filters.selectedSources.has(item.sourceId);
                item.display = withinStart && withinEnd && sourceActive;

                if (withinStart && withinEnd) {
                    const state = sourceStates.find(s => s.url === item.sourceId);
                    if (state) state.count.visible++;
                }
            });
        };

        watch(filters, updateVisibility, { deep: true });

        const sortedArticles = computed(() => [...articles.value].sort((a, b) => {
            const dateDiff = b.date.toDateString() === a.date.toDateString() ? 0 : b.date - a.date;
            if (dateDiff === 0) {
                return (b.sourceStarred === a.sourceStarred) ? b.date - a.date : (b.sourceStarred ? 1 : -1);
            }
            return dateDiff;
        }));

        const toggleSource = (url) => {
            activeTag.value = 'custom';
            filters.selectedSources.has(url) ? filters.selectedSources.delete(url) : filters.selectedSources.add(url);
            if (filters.selectedSources.has(url)) {
                 const state = sourceStates.find(s => s.url === url);
                 if (state && state.status === 'waiting') fetchSource(state);
            }
        };

        const fetchSource = async (state) => {
            state.status = 'fetching';
            try {
                const bundle = await RSSEngine.process({
                    url: state.url,
                    name: state.displayName,
                    starred: state.starred
                });
                if (bundle.status === 'success') {
                    const original = FEED_CONFIG.find(f => f.url === state.url);
                    state.displayName = original.name ? original.name : `(${bundle.metadata.title})`;
                    bundle.items.forEach(item => {
                        if (!seenLinks.has(item.link)) {
                            seenLinks.add(item.link);
                            articles.value.push({
                                ...item,
                                display: true,
                                snippet_length: 160,
                                snippet: item.snippet,
                                sourceName: state.displayName
                            });
                        }
                    });
                    state.count.total = bundle.items.length;
                    state.status = 'success';
                    updateVisibility();
                } else { state.status = 'error'; }
            } catch (err) { state.status = 'error'; }
        };

        const refreshSource = (state) => {
            articles.value = articles.value.filter(a => a.sourceId !== state.url);
            fetchSource(state);
        };

        const setDatePreset = (days) => {
            dateMode.value = String(days);
            if (days === 'custom') return;

            if (days === 'ee'){
            filters.start = '';
            filters.end = '';
                return;
            } 
            filters.end = '';
            const start = new Date();
            start.setDate(start.getDate() - parseInt(days));
            filters.start = start.toISOString().split('T')[0];
        };

        const statusCounts = computed(() => {
            const counts = { waiting: 0, success: 0, error: 0 };
            sourceStates.forEach(s => {
                if (counts.hasOwnProperty(s.status)) counts[s.status]++;
            });
            return counts;
        });

        const totalItems = computed(() => articles.value.length);
        const displayedItems = computed(() => articles.value.filter(item => item.display).length);
        const articlesCount = computed(() => {
            const counts = articles.value.reduce((acc, item) => {
                const m = item.date.toISOString().slice(0, 7);
                acc[m] = (acc[m] || 0) + 1;
                return acc;
            }, {});
            return Object.entries(counts)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => b.month.localeCompare(a.month));
        });

        const formatDate = (d) => d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });

        const selectTag = (tag) => {
            activeTag.value = tag;
            filters.selectedSources.clear();
            if (tag === 'none') return;

            sourceStates.forEach(s => {
                const matches = tag === 'all' || s.tags.includes(tag);
                if (matches) {
                    filters.selectedSources.add(s.url);
                    if (s.status === 'waiting') fetchSource(s);
                }
            });
        };

        onMounted(() => {
            setDatePreset('1');
            viewMode.value = 'card';
            selectTag('star');
        });

        const getFavicon = (url) => {
            try {
                const hostname = new URL(url).hostname;
                return `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`;
            } catch (e) { return ''; }
        }

        return {
            articles, sortedArticles, sourceStates, filters, viewMode, allTags, activeTag,
            selectTag, toggleSource, formatDate, dateMode, setDatePreset, totalItems,
            displayedItems, statusCounts, articlesCount, refreshSource, getFavicon
        };
    }
}).mount('#app');
</script>
</body>
</html>